name: CI - Build, Test, Lint, Docker

on:
  workflow_dispatch:
  # push:
  #   branches:
  #     - master
  # pull_request:
  #   branches:
  #     - master

jobs:
  build-test-lint-docker:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.13.1"

      - name: Install dependencies
        run: npm ci
        working-directory: app

      - name: Run tests
        run: npm test
        working-directory: app

      - name: Run lint
        run: npm run lint
        working-directory: app

      # 1 Authenticate to Google Cloud with service account JSON
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 2 Install gcloud CLI
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # 3 Configure Docker to use gcloud credentials for Artifact Registry
      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      # 4 Build and push Docker image to Artifact Registry
      - name: Build and push Docker image
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          set -euo pipefail
          REPO="us-central1-docker.pkg.dev/${PROJECT_ID}/app-artifact-repo"
          IMAGE="${REPO}/devops-sample-app"

          echo "Building image: $IMAGE:${{ github.sha }}"
          docker build \
            -t "$IMAGE:${{ github.sha }}" \
            -f app/Dockerfile \
            app

          echo "Tagging 'latest'"
          docker tag "$IMAGE:${{ github.sha }}" "$IMAGE:latest"

          echo "Pushing image tags"
          docker push "$IMAGE:${{ github.sha }}"
          docker push "$IMAGE:latest"
  helm-deploy:
    name: Get GKE credentials & Helm deploy (upgrade --install)
    runs-on: ubuntu-latest
    needs: build-test-lint-docker
    environment: production
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up gcloud CLI
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Get GKE credentials (writes kubeconfig for this runner)
      uses: google-github-actions/get-gke-credentials@v1
      with:
        cluster_name: ${{ secrets.GKE_CLUSTER_NAME }}
        location: ${{ secrets.GKE_CLUSTER_LOCATION }}
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Verify kubectl connectivity
      run: |
        set -euo pipefail
        kubectl version --client
        kubectl get nodes --no-headers -o wide

    - name: Install jq (for parsing helm history)
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: Setup Helm
      uses: azure/setup-helm@v3
      with:
        version: v3.12.0

    - name: Ensure namespace exists
      run: |
        kubectl get namespace "${K8S_NAMESPACE}" || kubectl create namespace "${K8S_NAMESPACE}"

    - name: Capture previous Helm revision (if any)
      id: prev
      run: |
        RELEASE="${HELM_RELEASE_NAME}"
        NAMESPACE="${K8S_NAMESPACE}"
        if helm status "$RELEASE" -n "$NAMESPACE" > /dev/null 2>&1; then
          PREV=$(helm history "$RELEASE" -n "$NAMESPACE" --output json | jq -r '.[-1].revision' || echo "")
          echo "prev_rev=$PREV" >> $GITHUB_OUTPUT
        else
          echo "prev_rev=" >> $GITHUB_OUTPUT
        fi

    - name: Helm upgrade --install (wait)
      run: |
        set -e
        helm upgrade --install "$RELEASE" "$CHART" \
          --namespace "$NAMESPACE" \
          --set image.repository="${IMAGE_REPO}/${IMAGE}" \
          --set image.tag="${IMAGE_TAG}" \
          --wait --timeout 5m

