name: CI - Build, Test, Lint, Docker

on:
  workflow_dispatch:
  # push:
  #   branches:
  #     - master
  # pull_request:
  #   branches:
  #     - master

jobs:
  build-test-lint-docker:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.13.1"

      - name: Install dependencies
        run: npm ci
        working-directory: app

      - name: Run tests
        run: npm test
        working-directory: app

      - name: Run lint
        run: npm run lint
        working-directory: app

      # 1 Authenticate to Google Cloud with service account JSON
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 2 Install gcloud CLI
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # 3 Configure Docker to use gcloud credentials for Artifact Registry
      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      # 4 Build and push Docker image to Artifact Registry
      - name: Build and push Docker image
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }} 
        run: |
          REPO="us-central1-docker.pkg.dev/${PROJECT_ID}/app-artifact-repo"
          IMAGE="${REPO}/devops-sample-app"

          echo "Building image: $IMAGE:${{ github.sha }}"
          docker build \
            -t "$IMAGE:${{ github.sha }}" \
            -f app/Dockerfile \
            app

          echo "Tagging 'latest'"
          docker tag "$IMAGE:${{ github.sha }}" "$IMAGE:latest"

          echo "Pushing image tags"
          docker push "$IMAGE:${{ github.sha }}"
          docker push "$IMAGE:latest"
  get-kube-credentials:
    name: Get GKE credentials
    runs-on: ubuntu-latest
    needs: build-test-lint-docker
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Get credentials for cluster
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          CLUSTER: ${{ secrets.GKE_CLUSTER_NAME }}
          LOCATION: ${{ secrets.GKE_CLUSTER_LOCATION }}
        run: |
          # try regional then zonal
          set -e
          gcloud container clusters get-credentials "$CLUSTER" --project "$PROJECT_ID" --region "$LOCATION" || \
            gcloud container clusters get-credentials "$CLUSTER" --project "$PROJECT_ID" --zone "$LOCATION"

      - name: Verify kubectl connectivity
        run: |
          kubectl version --client
          kubectl get nodes --no-headers -o wide || true
